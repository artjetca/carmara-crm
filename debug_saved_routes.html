<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Saved Routes - Casmara CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section { 
            border: 1px solid #ccc; 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 5px; 
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            border-radius: 3px; 
        }
        button:hover { background: #0056b3; }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto; 
        }
        #results { 
            max-height: 400px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Casmara CRM - Saved Routes èª¿è©¦å·¥å…·</h1>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 1: Supabase é€£æ¥æ¸¬è©¦</h2>
        <p>é¦–å…ˆæ¸¬è©¦ Supabase é€£æ¥æ˜¯å¦æ­£å¸¸</p>
        <button onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 2: ç”¨æˆ¶èªè­‰æ¸¬è©¦</h2>
        <p>æª¢æŸ¥æ˜¯å¦æœ‰ç™»å…¥çš„ç”¨æˆ¶</p>
        <button onclick="testAuth()">æ¸¬è©¦èªè­‰</button>
        <div id="auth-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 3: saved_routes è¡¨å­˜åœ¨æ€§æ¸¬è©¦</h2>
        <p>æª¢æŸ¥ saved_routes è¡¨æ˜¯å¦å­˜åœ¨</p>
        <button onclick="testTable()">æ¸¬è©¦è¡¨å­˜åœ¨</button>
        <div id="table-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 4: æ¸¬è©¦æ’å…¥è·¯ç·š</h2>
        <p>å˜—è©¦æ’å…¥ä¸€æ¢æ¸¬è©¦è·¯ç·š</p>
        <button onclick="testInsert()">æ¸¬è©¦æ’å…¥</button>
        <div id="insert-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 5: æ¸¬è©¦è®€å–è·¯ç·š</h2>
        <p>è®€å–æ‰€æœ‰å·²å„²å­˜çš„è·¯ç·š</p>
        <button onclick="testSelect()">æ¸¬è©¦è®€å–</button>
        <div id="select-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æ­¥é©Ÿ 6: æ¸…ç†æ¸¬è©¦æ•¸æ“š</h2>
        <p>åˆªé™¤æ¸¬è©¦è·¯ç·šï¼ˆå¯é¸ï¼‰</p>
        <button onclick="cleanupTest()">æ¸…ç†æ¸¬è©¦æ•¸æ“š</button>
        <div id="cleanup-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸš¨ å®Œæ•´è¨ºæ–·çµæœ</h2>
        <button onclick="runFullDiagnosis()">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
        <div id="results"></div>
    </div>

    <script>
        // é…ç½® Supabaseï¼ˆå¾ç’°å¢ƒè®Šæ•¸æˆ–ç›´æ¥é…ç½®ï¼‰
        const SUPABASE_URL = 'https://xpifsnwcjxklqvfvvzmw.supabase.co' // æ›¿æ›ç‚ºä½ çš„ URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwaWZzbndjanhra3F2ZnZ2em13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzNzk2NTMsImV4cCI6MjA0OTk1NTY1M30.rvBJGr0YWzHYudVNxRlPBa2D1Zv6EOrdmBa4W7psJgs' // æ›¿æ›ç‚ºä½ çš„ key
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function log(message, type = 'info') {
            const results = document.getElementById('results')
            const timestamp = new Date().toLocaleTimeString()
            results.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`
            results.scrollTop = results.scrollHeight
        }
        
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result')
            try {
                const { data, error } = await supabase.from('customers').select('count(*)').limit(1)
                if (error) {
                    resultDiv.innerHTML = `<div class="error">âŒ é€£æ¥å¤±æ•—: ${error.message}</div>`
                    log(`é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error')
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… Supabase é€£æ¥æ­£å¸¸</div>`
                    log('Supabase é€£æ¥æ¸¬è©¦æˆåŠŸ', 'success')
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ é€£æ¥éŒ¯èª¤: ${err.message}</div>`
                log(`é€£æ¥ç•°å¸¸: ${err.message}`, 'error')
            }
        }
        
        async function testAuth() {
            const resultDiv = document.getElementById('auth-result')
            try {
                const { data: { user }, error } = await supabase.auth.getUser()
                if (error || !user) {
                    resultDiv.innerHTML = `<div class="error">âŒ æœªç™»å…¥æˆ–èªè­‰å¤±æ•—</div>`
                    log('ç”¨æˆ¶æœªç™»å…¥ - éœ€è¦å…ˆç™»å…¥æ‰èƒ½æ¸¬è©¦ saved_routes', 'error')
                    return null
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… ç”¨æˆ¶å·²ç™»å…¥: ${user.email}</div>`
                    log(`ç”¨æˆ¶èªè­‰æˆåŠŸ: ${user.email}`, 'success')
                    return user
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ èªè­‰éŒ¯èª¤: ${err.message}</div>`
                log(`èªè­‰ç•°å¸¸: ${err.message}`, 'error')
                return null
            }
        }
        
        async function testTable() {
            const resultDiv = document.getElementById('table-result')
            try {
                const { data, error } = await supabase.from('saved_routes').select('count(*)').limit(1)
                if (error) {
                    if (error.message.includes('relation "public.saved_routes" does not exist')) {
                        resultDiv.innerHTML = `<div class="error">âŒ saved_routes è¡¨ä¸å­˜åœ¨ï¼éœ€è¦åŸ·è¡Œ SQL è…³æœ¬</div>`
                        log('saved_routes è¡¨ä¸å­˜åœ¨ - éœ€è¦åœ¨ Supabase Dashboard åŸ·è¡Œ SQL è…³æœ¬', 'error')
                    } else {
                        resultDiv.innerHTML = `<div class="error">âŒ è¡¨æ¸¬è©¦å¤±æ•—: ${error.message}</div>`
                        log(`è¡¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error')
                    }
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… saved_routes è¡¨å­˜åœ¨</div>`
                    log('saved_routes è¡¨å­˜åœ¨ä¸”å¯è¨ªå•', 'success')
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ è¡¨æ¸¬è©¦éŒ¯èª¤: ${err.message}</div>`
                log(`è¡¨æ¸¬è©¦ç•°å¸¸: ${err.message}`, 'error')
            }
        }
        
        async function testInsert() {
            const resultDiv = document.getElementById('insert-result')
            const user = await supabase.auth.getUser()
            
            if (!user.data.user) {
                resultDiv.innerHTML = `<div class="error">âŒ éœ€è¦å…ˆç™»å…¥</div>`
                return
            }
            
            try {
                const testRoute = {
                    name: 'Debug Test Route - ' + new Date().toISOString(),
                    route_date: '2024-01-01',
                    route_time: '10:00',
                    customers: [{ id: 'test', name: 'Test Customer' }],
                    total_distance: 10.5,
                    total_duration: 30,
                    created_by: user.data.user.id
                }
                
                const { data, error } = await supabase
                    .from('saved_routes')
                    .insert([testRoute])
                    .select()
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">âŒ æ’å…¥å¤±æ•—: ${error.message}</div>`
                    log(`è·¯ç·šæ’å…¥å¤±æ•—: ${error.message}`, 'error')
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… æˆåŠŸæ’å…¥æ¸¬è©¦è·¯ç·š: ${data[0].id}</div>`
                    log(`è·¯ç·šæ’å…¥æˆåŠŸ: ${data[0].name} (ID: ${data[0].id})`, 'success')
                    window.testRouteId = data[0].id
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ æ’å…¥éŒ¯èª¤: ${err.message}</div>`
                log(`æ’å…¥ç•°å¸¸: ${err.message}`, 'error')
            }
        }
        
        async function testSelect() {
            const resultDiv = document.getElementById('select-result')
            const user = await supabase.auth.getUser()
            
            if (!user.data.user) {
                resultDiv.innerHTML = `<div class="error">âŒ éœ€è¦å…ˆç™»å…¥</div>`
                return
            }
            
            try {
                const { data, error } = await supabase
                    .from('saved_routes')
                    .select('*')
                    .eq('created_by', user.data.user.id)
                    .order('created_at', { ascending: false })
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">âŒ è®€å–å¤±æ•—: ${error.message}</div>`
                    log(`è·¯ç·šè®€å–å¤±æ•—: ${error.message}`, 'error')
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… æˆåŠŸè®€å– ${data.length} æ¢è·¯ç·š</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`
                    log(`è·¯ç·šè®€å–æˆåŠŸ: æ‰¾åˆ° ${data.length} æ¢è·¯ç·š`, 'success')
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ è®€å–éŒ¯èª¤: ${err.message}</div>`
                log(`è®€å–ç•°å¸¸: ${err.message}`, 'error')
            }
        }
        
        async function cleanupTest() {
            const resultDiv = document.getElementById('cleanup-result')
            if (!window.testRouteId) {
                resultDiv.innerHTML = `<div class="info">â„¹ï¸ æ²’æœ‰æ¸¬è©¦è·¯ç·šéœ€è¦æ¸…ç†</div>`
                return
            }
            
            try {
                const { error } = await supabase
                    .from('saved_routes')
                    .delete()
                    .eq('id', window.testRouteId)
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">âŒ æ¸…ç†å¤±æ•—: ${error.message}</div>`
                    log(`æ¸¬è©¦æ•¸æ“šæ¸…ç†å¤±æ•—: ${error.message}`, 'error')
                } else {
                    resultDiv.innerHTML = `<div class="success">âœ… æ¸¬è©¦è·¯ç·šå·²æ¸…ç†</div>`
                    log('æ¸¬è©¦æ•¸æ“šæ¸…ç†æˆåŠŸ', 'success')
                    window.testRouteId = null
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">âŒ æ¸…ç†éŒ¯èª¤: ${err.message}</div>`
                log(`æ¸…ç†ç•°å¸¸: ${err.message}`, 'error')
            }
        }
        
        async function runFullDiagnosis() {
            document.getElementById('results').innerHTML = '<h3>ğŸ” é–‹å§‹å®Œæ•´è¨ºæ–·...</h3>'
            
            log('=== é–‹å§‹å®Œæ•´è¨ºæ–· ===', 'info')
            log('1. æ¸¬è©¦ Supabase é€£æ¥...', 'info')
            await testConnection()
            
            log('2. æ¸¬è©¦ç”¨æˆ¶èªè­‰...', 'info')
            const user = await testAuth()
            
            log('3. æ¸¬è©¦ saved_routes è¡¨...', 'info')
            await testTable()
            
            if (user) {
                log('4. æ¸¬è©¦æ’å…¥æ“ä½œ...', 'info')
                await testInsert()
                
                log('5. æ¸¬è©¦è®€å–æ“ä½œ...', 'info')
                await testSelect()
            } else {
                log('4-5. è·³éæ’å…¥/è®€å–æ¸¬è©¦ (ç”¨æˆ¶æœªç™»å…¥)', 'error')
            }
            
            log('=== è¨ºæ–·å®Œæˆ ===', 'info')
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºé…ç½®ä¿¡æ¯
        window.addEventListener('load', () => {
            log(`Supabase URL: ${SUPABASE_URL}`, 'info')
            log('èª¿è©¦å·¥å…·å·²æº–å‚™å°±ç·’', 'info')
        })
    </script>
</body>
</html>
